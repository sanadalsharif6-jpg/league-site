{% extends "league/base.html" %}
{% block title %}Fixtures{% endblock %}
{% block content %}

<div class="d-flex flex-wrap align-items-end justify-content-between gap-3 mb-3">
  <div>
    <h2 class="mb-0">Fixtures</h2>
    <div class="text-muted small">Filter by table, team, status, or date range.</div>
  </div>
</div>

<form method="get" class="xl-filterbar card card-body mb-4">
  <div class="row g-3 align-items-end">
    <div class="col-12 col-lg-3">
      <label class="form-label">Table</label>
      <select class="form-select" name="scope">
        <option value="">All tables</option>
        {% for sc in scopes %}
          <option value="{{ sc.id }}" {% if filters.scope|stringformat:"s" == sc.id|stringformat:"s" %}selected{% endif %}>
            {{ sc.division.name }} — {{ sc.group.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-12 col-lg-3">
      <label class="form-label">Team</label>
      <select class="form-select" name="team">
        <option value="">All teams</option>
        {% for t in teams %}
          <option value="{{ t.id }}" {% if filters.team|stringformat:"s" == t.id|stringformat:"s" %}selected{% endif %}>{{ t.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-12 col-lg-2">
      <label class="form-label">Status</label>
      <select class="form-select" name="status">
        <option value="all" {% if filters.status == "all" %}selected{% endif %}>All</option>
        <option value="played" {% if filters.status == "played" %}selected{% endif %}>Played</option>
        <option value="upcoming" {% if filters.status == "upcoming" %}selected{% endif %}>Upcoming</option>
      </select>
    </div>

    <div class="col-12 col-lg-2">
      <label class="form-label">From</label>
      <input class="form-control" type="date" name="from" value="{{ filters.from }}">
    </div>

    <div class="col-12 col-lg-2">
      <label class="form-label">To</label>
      <input class="form-control" type="date" name="to" value="{{ filters.to }}">
    </div>

    <div class="col-12 col-lg-4">
      <label class="form-label">Search</label>
      <input class="form-control" name="q" placeholder="Type a team name…" value="{{ filters.q }}">
    </div>

    <div class="col-12 col-lg-2 d-grid">
      <button class="btn btn-primary xl-btn" type="submit">Apply</button>
    </div>

    <div class="col-12 col-lg-2 d-grid">
      <a class="btn btn-outline-secondary" href="{% url 'league:fixtures' %}">Reset</a>
    </div>
  </div>
</form>

{% if not fixtures_by_scope %}
  <p class="text-muted">No fixtures.</p>
{% endif %}

{% for block in fixtures_by_scope %}
  <div class="card xl-card mb-4">
    <div class="card-header d-flex align-items-center justify-content-between flex-wrap gap-2">
      <div class="fw-semibold">
        {{ block.scope.division.name }} — {{ block.scope.group.name }}
      </div>
      <div class="text-muted small">Table ID: {{ block.scope.id }}</div>
    </div>

    <div class="card-body">
      {% if not block.gameweeks %}
        <p class="text-muted mb-0">No fixtures match your filters.</p>
      {% endif %}

      {% for gwb in block.gameweeks %}
        <div class="d-flex align-items-center justify-content-between mt-3 mb-2">
          <h6 class="mb-0">
            {% if gwb.gw %}GW{{ gwb.gw.number }}{% else %}Other{% endif %}
            {% if gwb.gw and gwb.gw.name %}<span class="text-muted">— {{ gwb.gw.name }}</span>{% endif %}
          </h6>
        </div>

        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle xl-table">
            <thead>
              <tr>
                <th class="text-nowrap">Date</th>
                <th>Match</th>
                <th class="text-nowrap">Score</th>
                <th class="text-nowrap">Match Pts</th>
              </tr>
            </thead>
            <tbody>
              {% for f in gwb.fixtures %}
                <tr>
                  <td class="text-nowrap small xl-date fw-semibold">{{ f.kickoff_at|date:"Y-m-d H:i" }}</td>
                  <td>
                    <div class="d-flex align-items-center gap-2 flex-wrap">
                      <a class="text-decoration-none" href="{% url 'league:team_detail' f.home_team.id %}">{{ f.home_team.name }}</a>
                      <span class="text-muted">vs</span>
                      <a class="text-decoration-none" href="{% url 'league:team_detail' f.away_team.id %}">{{ f.away_team.name }}</a>
                      {% if f.is_played %}
                        <span class="badge text-bg-success ms-2">Played</span>
                      {% else %}
                        <span class="badge text-bg-secondary ms-2">Upcoming</span>
                      {% endif %}
                    </div>
                  </td>
                  <td class="text-nowrap">
                    {% if f.result %}
                      <span class="fw-semibold">{{ f.home_total_points }}</span> - <span class="fw-semibold">{{ f.away_total_points }}</span>
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                  <td class="text-nowrap">
                    <span class="badge xl-badge">{{ f.home_match_points }}</span>
                    <span class="text-muted mx-1">:</span>
                    <span class="badge xl-badge">{{ f.away_match_points }}</span>
                  </td>
                </tr>
              {% empty %}
                <tr><td colspan="4" class="text-muted">No fixtures.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% endfor %}
    </div>
  </div>
{% endfor %}

{% endblock %}
