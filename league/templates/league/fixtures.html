{% extends "league/base.html" %}
{% block title %}Fixtures{% endblock %}
{% block content %}
<h2>Fixtures</h2>

<div class="card">
  <form method="get" class="filterbar">
    <div class="field">
      <label>Table / Group</label>
      <select name="scope">
        <option value="">All</option>
        {% for sc in all_scopes %}
          <option value="{{ sc.id }}" {% if filters.scope|default:'' == sc.id|stringformat:"s" %}selected{% endif %}>
            {{ sc.division.name }} — {{ sc.group.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="field">
      <label>Team</label>
      <select name="team">
        <option value="">All</option>
        {% for t in teams_for_filter %}
          <option value="{{ t.id }}" {% if filters.team|default:'' == t.id|stringformat:"s" %}selected{% endif %}>{{ t.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="field">
      <label>Status</label>
      <select name="status">
        <option value="" {% if not filters.status %}selected{% endif %}>All</option>
        <option value="played" {% if filters.status == "played" %}selected{% endif %}>Played</option>
        <option value="upcoming" {% if filters.status == "upcoming" %}selected{% endif %}>Upcoming</option>
      </select>
    </div>

    <div class="field">
      <label>From</label>
      <input type="date" name="date_from" value="{{ filters.date_from }}">
    </div>

    <div class="field">
      <label>To</label>
      <input type="date" name="date_to" value="{{ filters.date_to }}">
    </div>

    <div class="field" style="min-width:220px;flex:1">
      <label>Search</label>
      <input type="text" name="q" placeholder="Team name..." value="{{ filters.q }}">
    </div>

    <button type="submit">Apply</button>
  </form>
</div>

{% for block in fixtures_by_scope %}
  <div class="scope-box">
    <h3>{{ block.scope.division.name }} — {{ block.scope.group.name }}</h3>

    {% for gwb in block.gameweeks %}
      <h4>GW{{ gwb.gw.number }} {% if gwb.gw.name %}- {{ gwb.gw.name }}{% endif %}</h4>
      {% if not gwb.fixtures %}
        <p class="muted">No fixtures.</p>
      {% else %}
        <div class="table-wrap"><table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Match</th>
              <th>Score</th>
              <th>Match Pts</th>
            </tr>
          </thead>
          <tbody>
            {% for f in gwb.fixtures %}
              <tr>
                <td class="date">{{ f.kickoff_at|date:"Y-m-d H:i" }}</td>
                <td>
                  {% if f.home_team.logo %}<img class="logo" src="{{ f.home_team.logo.url }}" alt="">{% endif %}
                  {{ f.home_team.name }}
                  vs
                  {% if f.away_team.logo %}<img class="logo" src="{{ f.away_team.logo.url }}" alt="">{% endif %}
                  {{ f.away_team.name }}
                </td>
                <td>
                  {% if f.is_played %}
                    <b>{{ f.home_total_points }}</b> - <b>{{ f.away_total_points }}</b>
                  {% else %}
                    <span class="muted">—</span>
                  {% endif %}
                </td>
                <td class="muted">{{ f.home_match_points }} - {{ f.away_match_points }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table></div>
      {% endif %}
    {% endfor %}
  </div>
{% endfor %}

{% endblock %}
